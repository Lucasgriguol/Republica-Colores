<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Pinturer√≠a ‚Äî Reservas / Presupuesto</title>

    <link rel="stylesheet" href="styles.css">

    <style>
        /* Scoped styles (coinciden con look & feel del resto) */
        .site-header {
            background: #fff;
            border-bottom: 1px solid rgba(16, 24, 40, 0.04);
            position: sticky;
            top: 0;
            z-index: 60;
            box-shadow: 0 1px 0 rgba(16, 24, 40, 0.02);
        }

        .site-header__inner {
            display: flex;
            align-items: center;
            gap: 18px;
            padding: 12px 20px;
            justify-content: space-between;
        }

        .site-brand .brand-link {
            color: var(--brand, #1565c0);
            font-weight: 800;
            font-size: 18px;
            text-decoration: none
        }

        .site-nav__list {
            display: flex;
            gap: 14px;
            list-style: none;
            margin: 0;
            padding: 0
        }

        .site-tools {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .site-search__input {
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid #e9eef8;
            min-width: 180px
        }

        .site-reserve {
            background: transparent;
            border: 0;
            font-size: 16px;
            cursor: pointer;
            padding: 8px;
            color: var(--brand, #1565c0);
            font-weight: 700
        }

        .site-admin-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: 0;
            background: #f3f6fb;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 0 rgba(16, 24, 40, 0.02);
        }

        .reserva-page {
            padding: 28px 0;
        }

        .reserva-grid {
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 20px;
            align-items: start;
        }

        @media (max-width:980px) {
            .reserva-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card);
            border-radius: 10px;
            padding: 14px;
            box-shadow: 0 10px 30px rgba(16, 24, 40, 0.04);
            border: 1px solid rgba(16, 24, 40, 0.03);
        }

        .cart-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
            max-height: 560px;
            overflow: auto;
        }

        .cart-item {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            border: 1px dashed rgba(16, 24, 40, 0.04);
        }

        .cart-item .thumb {
            width: 76px;
            height: 64px;
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fafafa;
        }

        .cart-item .thumb img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
        }

        .cart-item .meta {
            flex: 1;
            min-width: 0;
        }

        .cart-item h4 {
            margin: 0;
            font-size: 15px;
            line-height: 1.2;
        }

        .cart-item .price {
            color: var(--brand);
            font-weight: 800;
            margin-top: 6px;
        }

        .qty-controls {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .qty-controls button {
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid #eef6fb;
            background: #fff;
            cursor: pointer;
        }

        .empty-msg {
            text-align: center;
            color: var(--muted);
            padding: 24px;
        }

        .form-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }

        .form-row label {
            font-weight: 700;
            font-size: 13px;
        }

        .form-row input {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #eef6fb;
            width: 100%;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed rgba(16, 24, 40, 0.04);
        }

        .total {
            font-size: 18px;
            font-weight: 900;
            color: var(--brand);
            margin-top: 10px;
            text-align: right;
        }

        .actions-row {
            display: flex;
            gap: 8px;
            margin-top: 14px;
            justify-content: flex-end;
        }

        .note-small {
            color: var(--muted);
            font-size: 13px;
            margin-top: 8px;
        }

        /* admin modal */
        .admin-modal-back {
            position: fixed;
            inset: 0;
            background: rgba(2, 6, 23, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2200;
        }

        .admin-modal {
            width: 920px;
            max-width: 96%;
            background: #fff;
            border-radius: 10px;
            padding: 18px;
            box-shadow: 0 18px 60px rgba(2, 6, 23, 0.4);
            max-height: 85vh;
            overflow: auto;
        }

        .admin-panel table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .admin-panel th,
        .admin-panel td {
            padding: 8px 10px;
            border-bottom: 1px solid #eef2f7;
            text-align: left;
            vertical-align: top;
        }

        .danger {
            color: #b91c1c;
        }
    </style>
</head>

<body>
    <!-- NAVBAR -->
    <header class="site-header" role="banner">
        <div class="site-header__inner container">
            <div class="site-brand">
                <a href="index.html" class="brand-link">Rep√∫blica Colores</a>
            </div>

            <nav class="site-nav" role="navigation" aria-label="Navegaci√≥n principal">
                <ul class="site-nav__list">
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="productos.html">Productos</a></li>
                    <li><a href="promociones.html">Promociones</a></li>
                    <li><a href="reservas.html" aria-current="page">Reservas</a></li>
                </ul>
            </nav>

            <div class="site-tools">
                <form class="site-search" role="search" onsubmit="event.preventDefault(); applyHeaderSearch();">
                    <input id="globalSearch" class="site-search__input" type="search"
                        placeholder="Buscar producto, marca o c√≥digo" aria-label="Buscar">
                    <button type="button" class="site-search__btn" onclick="applyHeaderSearch()">Buscar</button>
                </form>

                <button class="site-reserve" onclick="location.href='reservas.html'">Reservas</button>
                <button id="adminBtn" class="site-admin-btn" title="Admin" aria-label="Admin">üîí</button>

            </div>
        </div>

        <div id="site-menu" class="site-menu" hidden>
            <div class="container">
                <ul class="site-menu__list">
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="productos.html">Productos</a></li>
                    <li><a href="promociones.html">Promociones</a></li>
                    <li><a href="reservas.html">Reservas</a></li>
                </ul>
            </div>
        </div>
    </header>


    <!-- MAIN RESERVAS -->
    <main class="container reserva-page">
        <h1>Reservas / Presupuesto</h1>
        <p class="small muted">Agreg√° productos (por ID) o peg√° el ID desde la ficha de producto. Complet√° nombre y DNI
            para reservar o generar un presupuesto.</p>

        <div class="reserva-grid">
            <!-- LEFT: carrito (en memoria) -->
            <section class="card">
                <div style="display:flex;gap:10px;align-items:center;">
                    <input id="addProductId" placeholder="Ingresar ID de producto"
                        style="flex:1;padding:10px;border-radius:8px;border:1px solid #eef6fb">
                    <button id="btnAdd" class="btn btn-primary">Agregar</button>
                </div>

                <div class="cart-list" id="cartList" aria-live="polite" style="margin-top:12px">
                    <div class="empty-msg">No hay productos en la reserva. Agreg√° el ID de un producto para comenzar.
                    </div>
                </div>

                <div style="margin-top:12px; display:flex; gap:8px; justify-content:space-between; align-items:center;">
                    <div class="note-small">Los precios se toman desde el inventario (Firestore).</div>
                    <button id="clearCart" class="btn">Vaciar</button>
                </div>
            </section>

            <!-- RIGHT: formulario y resumen -->
            <aside>
                <div class="card">
                    <h3>Datos para la reserva</h3>
                    <div class="form-row">
                        <label for="resName">Nombre completo</label>
                        <input id="resName" placeholder="Ej: Juan P√©rez">
                    </div>
                    <div class="form-row">
                        <label for="resDni">DNI</label>
                        <input id="resDni" placeholder="Ej: 20123456">
                    </div>

                    <div class="card" style="margin-top:10px">
                        <h4>Resumen</h4>
                        <div id="summaryRows" style="margin-top:8px"></div>
                        <div class="total" id="totalAmount">$ 0</div>
                        <div class="actions-row">
                            <button id="btnReserve" class="btn btn-primary">Reservar / Generar presupuesto</button>
                            <button id="btnDownload" class="btn btn-ghost">Descargar resumen</button>
                        </div>
                        <div id="resultMessage" style="margin-top:10px"></div>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <!-- ADMIN modal -->
    <div id="adminModalBack" class="admin-modal-back" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="admin-modal">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <h2 style="margin:0">√Årea admin ‚Äî Reservas</h2>
                    <div class="small muted">Solo para administradores</div>
                </div>
                <div><button id="adminCloseTop" class="btn btn-ghost">Cerrar</button></div>
            </div>

            <div id="adminLoginBlock" style="margin-top:14px">
                <div style="display:flex;gap:10px;align-items:center">
                    <input id="adminPinInput" placeholder="Ingres√° PIN"
                        style="padding:10px;border-radius:8px;border:1px solid #eef6fb" />
                    <button id="adminLoginBtn" class="btn btn-primary">Entrar</button>
                    <div id="adminLoginMsg" class="small muted" style="margin-left:12px"></div>
                </div>
            </div>

            <div id="adminContent" style="display:none;margin-top:16px">
                <div style="display:flex;gap:8px;align-items:center">
                    <button id="adminSignout" class="btn">Cerrar sesi√≥n admin</button>
                    <button id="refreshReservations" class="btn btn-primary">Actualizar</button>
                    <button id="deleteAllReservations" class="btn danger">Vaciar todo</button>
                </div>
                <div style="margin-top:12px" class="admin-panel" id="adminPanel">
                    <div class="small muted">Cargando reservas‚Ä¶</div>
                </div>
            </div>
        </div>
    </div>

    <footer class="site-footer" role="contentinfo">
        <div class="site-footer__inner container">
            <div class="footer-col about"><a href="index.html" class="brand-link"><strong>Rep√∫blica Colores</strong></a>
                <p class="small muted">Soluciones en pinturas y terminaciones.</p>
            </div>
            <div class="footer-col links">
                <h4>Enlaces</h4>
                <ul>
                    <li><a href="productos.html">Productos</a></li>
                    <li><a href="promociones.html">Promociones</a></li>
                    <li><a href="reservas.html">Reservas</a></li>
                </ul>
            </div>
            <div class="footer-col contact">
                <h4>Contacto</h4>
                <p class="small muted">San Jer√≥nimo 3321 ‚Ä¢ C√≥rdoba, AR</p>
                <p class="small muted">Tel: +54 351 618 5138</p>
            </div>
            <div class="footer-col social">
                <h4>S√≠guenos</h4>
                <div class="social-icons"><a href="#" aria-label="Facebook">üëç</a><a href="#"
                        aria-label="Instagram">üì∏</a></div>
            </div>
        </div>
        <div class="site-footer__bottom container">
            <div class="small muted">¬© <span id="footerYear"></span> Rep√∫blica Colores ‚Äî Todos los derechos reservados
            </div>
        </div>
    </footer>

    <!-- FIREBASE + LOGICA -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import {
            getFirestore, collection, getDocs, addDoc, serverTimestamp, doc, getDoc, deleteDoc
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDPVbxfvJO-w-j6lGL-TEFeHNJRV7G1UTo",
            authDomain: "inventario-b8fc2.firebaseapp.com",
            projectId: "inventario-b8fc2",
            storageBucket: "inventario-b8fc2.firebasestorage.app",
            messagingSenderId: "184222469977",
            appId: "1:184222469977:web:83cc7bcc7116eb43494648"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // colecciones candidatas para productos
        const COLLECTIONS = ['productos', 'products', 'items', 'inventario', 'productosListado'];

        // DOM
        const addInput = document.getElementById('addProductId');
        const btnAdd = document.getElementById('btnAdd');
        const cartList = document.getElementById('cartList');
        const clearCartBtn = document.getElementById('clearCart');
        const summaryRows = document.getElementById('summaryRows');
        const totalAmount = document.getElementById('totalAmount');
        const btnReserve = document.getElementById('btnReserve');
        const btnDownload = document.getElementById('btnDownload');
        const resultMessage = document.getElementById('resultMessage');
        const nameInput = document.getElementById('resName');
        const dniInput = document.getElementById('resDni');

        // admin DOM
        const adminBtn = document.getElementById('adminBtn');
        const adminModalBack = document.getElementById('adminModalBack');
        const adminCloseTop = document.getElementById('adminCloseTop');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const adminPinInput = document.getElementById('adminPinInput');
        const adminLoginMsg = document.getElementById('adminLoginMsg');
        const adminLoginBlock = document.getElementById('adminLoginBlock');
        const adminContent = document.getElementById('adminContent');
        const adminPanel = document.getElementById('adminPanel');
        const adminSignout = document.getElementById('adminSignout');
        const refreshReservations = document.getElementById('refreshReservations');
        const deleteAllReservations = document.getElementById('deleteAllReservations');

        // CART in-memory (no localStorage)
        let CART = []; // [{ id, name, price, qty, image, _collection }]

        // PIN obfuscation (decoded yields '1965')
        const PIN_OFFSET = 11;
        const encodedPin = [60, 68, 65, 64];
        function decodePin() { return encodedPin.map(c => String.fromCharCode(c - PIN_OFFSET)).join(''); }
        function verifyPinInput(value) { return String(value || '').trim() === decodePin(); }

        function formatPrice(v) {
            if (v == null || v === '') return 'Consultar';
            const n = Number(v);
            if (isNaN(n)) return 'Consultar';
            return '$' + n.toLocaleString('es-AR');
        }

        function escapeHtml(s) { return String(s || '').replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;'); }

        // find product by id in multiple collections
        async function findProductById(id) {
            id = String(id || '').trim();
            if (!id) return null;
            for (const name of COLLECTIONS) {
                try {
                    const docRef = doc(db, name, id);
                    const snap = await getDoc(docRef);
                    if (snap && snap.exists()) {
                        return { id: snap.id, ...snap.data(), _collection: name };
                    }
                } catch (e) { console.warn('err finding in', name, e); }
            }
            // fallback search by fields
            for (const name of COLLECTIONS) {
                try {
                    const colRef = collection(db, name);
                    const snap = await getDocs(colRef);
                    if (!snap.empty) {
                        for (const d of snap.docs) {
                            const data = d.data();
                            if (data.slug === id || d.id === id || (data.code && data.code === id)) {
                                return { id: d.id, ...data, _collection: name };
                            }
                        }
                    }
                } catch (e) { console.warn('err scanning', name, e); }
            }
            return null;
        }

        // add product to in-memory cart (fetch from Firestore if available)
        async function addProductById(id) {
            if (!id) return;
            resultMessage.textContent = '';
            // check if already in cart
            const existing = CART.find(c => c.id === id);
            if (existing) {
                existing.qty = (existing.qty || 1) + 1;
                renderCart();
                return;
            }
            // try to fetch product
            const p = await findProductById(id);
            if (p) {
                const item = {
                    id: p.id,
                    name: p.name || p.nombre || p.title || ('Producto ' + p.id),
                    price: p.price || p.precio || null,
                    image: p.imageUrl || p.image || (p.images && p.images[0]) || null,
                    qty: 1,
                    _collection: p._collection || null
                };
                CART.push(item);
            } else {
                // minimal fallback entry
                CART.push({ id, name: 'Producto: ' + id, price: null, image: null, qty: 1, _collection: null });
            }
            renderCart();
        }

        // render cart and summary (in-memory)
        function renderCart() {
            cartList.innerHTML = '';
            if (!CART || CART.length === 0) {
                cartList.innerHTML = '<div class="empty-msg">No hay productos en la reserva. Agreg√° el ID de un producto para comenzar.</div>';
                summaryRows.innerHTML = '';
                totalAmount.textContent = '$ 0';
                return;
            }
            CART.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'cart-item';
                div.innerHTML = `
          <div class="thumb"><img src="${item.image || 'https://via.placeholder.com/400x300?text=Sin+imagen'}" alt="${escapeHtml(item.name)}"></div>
          <div class="meta">
            <h4>${escapeHtml(item.name)}</h4>
            <div class="price">${formatPrice(item.price)}</div>
            <div class="note-small">ID: ${escapeHtml(item.id)}</div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
            <div class="qty-controls">
              <button data-action="dec" data-idx="${idx}">‚àí</button>
              <div style="min-width:28px;text-align:center">${item.qty}</div>
              <button data-action="inc" data-idx="${idx}">+</button>
            </div>
            <button data-action="remove" data-idx="${idx}" class="btn" style="font-size:12px;padding:6px 8px">Eliminar</button>
          </div>
        `;
                cartList.appendChild(div);
            });

            // wire controls
            cartList.querySelectorAll('[data-action]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const action = btn.getAttribute('data-action');
                    const idx = Number(btn.getAttribute('data-idx'));
                    if (Number.isNaN(idx) || !CART[idx]) return;
                    if (action === 'inc') CART[idx].qty = (CART[idx].qty || 1) + 1;
                    if (action === 'dec') { CART[idx].qty = (CART[idx].qty || 1) - 1; if (CART[idx].qty < 1) CART[idx].qty = 1; }
                    if (action === 'remove') { CART.splice(idx, 1); }
                    renderCart();
                });
            });

            // summary
            summaryRows.innerHTML = '';
            let tot = 0;
            CART.forEach(it => {
                const row = document.createElement('div');
                row.className = 'summary-row';
                const name = document.createElement('div'); name.textContent = `${it.name} √ó${it.qty}`;
                const p = document.createElement('div'); p.textContent = (it.price == null ? 'Consultar' : '$' + (Number(it.price) * it.qty).toLocaleString('es-AR'));
                row.appendChild(name); row.appendChild(p);
                summaryRows.appendChild(row);
                if (it.price != null && !isNaN(Number(it.price))) tot += Number(it.price) * (it.qty || 1);
            });
            totalAmount.textContent = formatPrice(tot);
        }

        // clear in-memory cart
        function clearCart() {
            CART = [];
            renderCart();
            resultMessage.textContent = 'Carrito vaciado.';
        }

        // submit reservation to Firestore
        async function submitReservation() {
            resultMessage.textContent = '';
            const name = (nameInput.value || '').trim();
            const dni = (dniInput.value || '').trim();
            if (!name) { resultMessage.innerHTML = '<div style="color:#b91c1c">Ingres√° el nombre.</div>'; return; }
            if (!dni || !/^\d+$/.test(dni)) { resultMessage.innerHTML = '<div style="color:#b91c1c">Ingres√° un DNI v√°lido (solo n√∫meros).</div>'; return; }
            if (!CART || CART.length === 0) { resultMessage.innerHTML = '<div style="color:#b91c1c">No hay productos en la reserva.</div>'; return; }

            const items = CART.map(it => ({
                id: it.id,
                name: it.name,
                price: (it.price == null) ? null : Number(it.price),
                qty: it.qty || 1,
                _collection: it._collection || null
            }));
            const total = items.reduce((s, it) => s + ((it.price != null && !isNaN(it.price)) ? it.price * it.qty : 0), 0);

            const payload = {
                name,
                dni,
                items,
                total,
                createdAt: serverTimestamp()
            };

            try {
                const colRef = collection(db, 'reservas');
                const docRef = await addDoc(colRef, payload);
                resultMessage.innerHTML = `<div style="color:green">Reserva registrada. ID: <strong>${docRef.id}</strong></div>`;
                // clear in-memory cart and form
                CART = [];
                renderCart();
                nameInput.value = '';
                dniInput.value = '';
            } catch (err) {
                console.error('err saving reserva', err);
                resultMessage.innerHTML = `<div style="color:#b91c1c">Error al guardar la reserva (ver consola).</div>`;
            }
        }

        // download summary (.txt)
        function downloadSummary() {
            if (!CART || CART.length === 0) { resultMessage.innerHTML = '<div style="color:#b91c1c">El carrito est√° vac√≠o.</div>'; return; }
            const name = (nameInput.value || '').trim() || 'Cliente';
            const dni = (dniInput.value || '').trim() || '-';
            let text = `Presupuesto / Reserva\nCliente: ${name}\nDNI: ${dni}\n\nItems:\n`;
            let tot = 0;
            CART.forEach(it => {
                const line = `- ${it.name} (ID: ${it.id}) x${it.qty} ‚Üí ${(it.price == null) ? 'Consultar' : ('$' + (Number(it.price) * it.qty).toLocaleString('es-AR'))}\n`;
                text += line;
                if (it.price != null && !isNaN(Number(it.price))) tot += Number(it.price) * it.qty;
            });
            text += `\nTotal estimado: ${formatPrice(tot)}\n\nGenerado: ${new Date().toLocaleString()}\n`;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reserva_${(name.replace(/\s+/g, '_') || 'cliente')}.txt`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 100);
        }

        // ADMIN: load reservations from Firestore and render with delete buttons
        async function loadReservations() {
            adminPanel.innerHTML = '<div class="small muted">Cargando reservas‚Ä¶</div>';
            try {
                const col = collection(db, 'reservas');
                const snap = await getDocs(col);
                if (snap.empty) { adminPanel.innerHTML = '<div class="small muted">No hay reservas registradas.</div>'; return; }
                let html = '<table><thead><tr><th>Nombre</th><th>DNI</th><th>Items</th><th>Total</th><th>Creado</th><th></th></tr></thead><tbody>';
                snap.forEach(d => {
                    const data = d.data();
                    const id = d.id;
                    const items = (data.items || []).map(it => `${escapeHtml(it.name)} x${it.qty}`).join('<br>');
                    const total = data.total == null ? 'Consultar' : ('$' + Number(data.total).toLocaleString('es-AR'));
                    let created = '';
                    if (data.createdAt && data.createdAt.toDate) {
                        try { created = data.createdAt.toDate().toLocaleString(); } catch (e) { created = String(data.createdAt); }
                    } else created = '-';
                    html += `<tr data-id="${id}"><td>${escapeHtml(data.name || '-')}</td><td>${escapeHtml(data.dni || '-')}</td><td style="min-width:220px">${items || '-'}</td><td>${total}</td><td>${created}</td><td><button class="btn btn-ghost btn-delete" data-id="${id}">Eliminar</button></td></tr>`;
                });
                html += '</tbody></table>';
                adminPanel.innerHTML = html;

                // wire delete buttons
                adminPanel.querySelectorAll('.btn-delete').forEach(b => {
                    b.addEventListener('click', async (e) => {
                        const id = b.getAttribute('data-id');
                        if (!id) return;
                        if (!confirm('Eliminar reserva ' + id + '? Esta acci√≥n no se puede deshacer.')) return;
                        try {
                            await deleteDoc(doc(db, 'reservas', id));
                            // remove row from UI
                            const row = adminPanel.querySelector(`tr[data-id="${id}"]`);
                            if (row) row.remove();
                        } catch (err) {
                            console.error('err deleting reserva', err);
                            alert('Error al eliminar (ver consola).');
                        }
                    });
                });

            } catch (err) {
                console.error('err cargando reservas', err);
                adminPanel.innerHTML = '<div class="small muted">Error cargando reservas (ver consola).</div>';
            }
        }

        // ADMIN: delete all reservations (careful)
        async function deleteAllReservationsHandler() {
            if (!confirm('¬øEliminar todas las reservas? Esta acci√≥n es irreversible.')) return;
            adminPanel.innerHTML = '<div class="small muted">Eliminando‚Ä¶</div>';
            try {
                const col = collection(db, 'reservas');
                const snap = await getDocs(col);
                if (snap.empty) { adminPanel.innerHTML = '<div class="small muted">No hay reservas para eliminar.</div>'; return; }
                // delete sequentially (Firestore doesn't allow batch delete in client without write/batch complexity)
                for (const d of snap.docs) {
                    try { await deleteDoc(doc(db, 'reservas', d.id)); } catch (e) { console.warn('err deleting', d.id, e); }
                }
                adminPanel.innerHTML = '<div class="small muted">Todas las reservas fueron eliminadas.</div>';
            } catch (err) {
                console.error('err deleting all', err);
                adminPanel.innerHTML = '<div class="small muted">Error al eliminar reservas (ver consola).</div>';
            }
        }

        // ADMIN modal helpers
        function openAdminModal() { adminModalBack.style.display = 'flex'; adminModalBack.setAttribute('aria-hidden', 'false'); const authed = sessionStorage.getItem('rc_admin_authed'); if (authed === '1') { adminLoginBlock.style.display = 'none'; adminContent.style.display = ''; loadReservations(); } else { adminLoginBlock.style.display = ''; adminContent.style.display = 'none'; adminPinInput.value = ''; adminLoginMsg.textContent = ''; adminPinInput.focus(); } }
        function closeAdminModal() { adminModalBack.style.display = 'none'; adminModalBack.setAttribute('aria-hidden', 'true'); }

        // event wiring
        btnAdd.addEventListener('click', async () => {
            const id = (addInput.value || '').trim();
            if (!id) return;
            btnAdd.disabled = true;
            await addProductById(id);
            addInput.value = '';
            btnAdd.disabled = false;
        });
        addInput.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') { e.preventDefault(); btnAdd.click(); }
        });

        clearCartBtn.addEventListener('click', () => clearCart());
        btnReserve.addEventListener('click', async () => { btnReserve.disabled = true; await submitReservation(); btnReserve.disabled = false; });
        btnDownload.addEventListener('click', () => downloadSummary());

        // admin events
        adminBtn.addEventListener('click', () => openAdminModal());
        adminCloseTop.addEventListener('click', () => closeAdminModal());
        adminModalBack.addEventListener('click', (e) => { if (e.target === adminModalBack) closeAdminModal(); });
        adminLoginBtn && adminLoginBtn.addEventListener('click', () => {
            const val = adminPinInput.value || '';
            if (verifyPinInput(val)) { sessionStorage.setItem('rc_admin_authed', '1'); adminLoginMsg.textContent = ''; adminLoginBlock.style.display = 'none'; adminContent.style.display = ''; loadReservations(); } else { adminLoginMsg.style.color = '#b91c1c'; adminLoginMsg.textContent = 'PIN incorrecto.'; }
        });
        adminSignout && adminSignout.addEventListener('click', () => { sessionStorage.removeItem('rc_admin_authed'); adminContent.style.display = 'none'; adminLoginBlock.style.display = ''; adminLoginMsg.textContent = 'Sesi√≥n cerrada.'; });
        refreshReservations && refreshReservations.addEventListener('click', () => loadReservations());
        deleteAllReservations && deleteAllReservations.addEventListener('click', () => deleteAllReservationsHandler());

        // admin PIN input shortcuts
        adminPinInput && adminPinInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { e.preventDefault(); adminLoginBtn && adminLoginBtn.click(); }
            if (e.key === 'Escape') { if (adminModalBack.style.display === 'flex') closeAdminModal(); }
        });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { if (adminModalBack.style.display === 'flex') closeAdminModal(); } });

        // header helpers
        function toggleSiteMenu() { const menu = document.getElementById('site-menu'); const btn = document.querySelector('.site-menu-toggle'); if (!menu) return; const isHidden = menu.hasAttribute('hidden'); if (isHidden) { menu.removeAttribute('hidden'); btn.setAttribute('aria-expanded', 'true'); } else { menu.setAttribute('hidden', ''); btn.setAttribute('aria-expanded', 'false'); } }
        function applyHeaderSearch() { const q = (document.getElementById('globalSearch') || { value: '' }).value.trim(); if (!q) { location.href = 'productos.html'; return; } location.href = 'productos.html?q=' + encodeURIComponent(q); }

        // prefill from ?id= (if reservas.html?id=...)
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('footerYear').textContent = new Date().getFullYear();
            const params = new URLSearchParams(location.search);
            const preid = params.get('id') || params.get('product');
            if (preid) {
                addInput.value = preid;
                // simulate click to add it (no await needed)
                btnAdd.click();
            }
            // render initial (empty) cart
            renderCart();
        });

        // expose small debug helpers
        window.rcReserva = {
            CART,
            addProductById,
            renderCart,
            submitReservation,
            loadReservations,
            decodePin,
            verifyPinInput
        };
    </script>
</body>

</html>