<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Pinturer√≠a ‚Äî Detalle de producto</title>

  <link rel="stylesheet" href="styles.css">

  <style>
    .site-header {
      background: #fff;
      border-bottom: 1px solid rgba(16, 24, 40, 0.04);
      position: sticky;
      top: 0;
      z-index: 60;
      box-shadow: 0 1px 0 rgba(16, 24, 40, 0.02);
    }

    .site-header__inner {
      display: flex;
      align-items: center;
      gap: 18px;
      padding: 12px 20px;
      justify-content: space-between;
    }

    .site-brand .brand-link {
      color: var(--brand, #1565c0);
      font-weight: 800;
      font-size: 18px;
      text-decoration: none
    }

    .site-nav__list {
      display: flex;
      gap: 14px;
      list-style: none;
      margin: 0;
      padding: 0
    }

    .site-tools {
      display: flex;
      align-items: center;
      gap: 8px
    }

    .site-search__input {
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #e9eef8;
      min-width: 180px
    }

    .site-reserve {
      background: transparent;
      border: 0;
      font-size: 16px;
      cursor: pointer;
      padding: 8px;
      color: var(--brand, #1565c0);
      font-weight: 700
    }

    .site-admin-btn {
      width: 36px;
      height: 36px;
      border-radius: 6px;
      border: 0;
      background: #f3f6fb;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 0 rgba(16, 24, 40, 0.02);
    }

    .product-page {
      padding: 28px 0;
    }

    .product-grid {
      display: grid;
      grid-template-columns: 480px 1fr;
      gap: 28px;
      align-items: start;
    }

    @media (max-width:980px) {
      .product-grid {
        grid-template-columns: 1fr;
      }
    }

    .product-media {
      background: #fff;
      padding: 14px;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(16, 24, 40, 0.04);
      border: 1px solid rgba(16, 24, 40, 0.03);
    }

    .product-media img {
      width: 100%;
      height: auto;
      border-radius: 8px;
      object-fit: contain;
      max-height: 420px;
      display: block;
    }

    .product-info h1 {
      margin: 0 0 10px 0;
      font-size: 26px;
      color: var(--brand);
    }

    .product-price {
      font-weight: 800;
      font-size: 20px;
      color: var(--brand);
      margin: 8px 0;
    }

    .product-actions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .product-desc {
      margin-top: 16px;
      background: #fff;
      padding: 14px;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(16, 24, 40, 0.03);
      border: 1px solid rgba(16, 24, 40, 0.02);
    }

    .admin-modal-back {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .admin-modal {
      width: 920px;
      max-width: 96%;
      background: #fff;
      border-radius: 10px;
      padding: 18px;
      box-shadow: 0 18px 60px rgba(2, 6, 23, 0.4);
      max-height: 85vh;
      overflow: auto;
    }

    .admin-panel table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .admin-panel th,
    .admin-panel td {
      padding: 8px 10px;
      border-bottom: 1px solid #eef2f7;
      text-align: left;
      vertical-align: top;
    }
  </style>
</head>

<body>

  <header class="site-header" role="banner">
    <div class="site-header__inner container">
      <div class="site-brand">
        <a href="index.html" class="brand-link">Rep√∫blica Colores</a>
      </div>

      <nav class="site-nav" role="navigation" aria-label="Navegaci√≥n principal">
        <ul class="site-nav__list">
          <li><a href="index.html" aria-current="page">Inicio</a></li>
          <li><a href="productos.html">Productos</a></li>
          <li><a href="promociones.html">Promociones</a></li>
          <li><a href="reservas.html">Reservas</a></li>
        </ul>
      </nav>

      <div class="site-tools">
        <form class="site-search" role="search" onsubmit="event.preventDefault(); applyHeaderSearch();">
          <input id="globalSearch" class="site-search__input" type="search"
            placeholder="Buscar producto, marca o c√≥digo" aria-label="Buscar">
          <button type="button" class="site-search__btn" onclick="applyHeaderSearch()">Buscar</button>
        </form>

        <button class="site-reserve" onclick="location.href='reservas.html'">Reservas</button>
        <button id="adminBtn" class="site-admin-btn" title="Admin" aria-label="Admin">üîí</button>

        <button class="site-menu-toggle" aria-label="Abrir men√∫" onclick="toggleSiteMenu()"
          aria-expanded="false">‚ò∞</button>
      </div>
    </div>

    <div id="site-menu" class="site-menu" hidden>
      <div class="container">
        <ul class="site-menu__list">
          <li><a href="index.html">Inicio</a></li>
          <li><a href="productos.html">Productos</a></li>
          <li><a href="promociones.html">Promociones</a></li>
          <li><a href="reservas.html">Reservas</a></li>
        </ul>
      </div>
    </div>
  </header>


  <main class="container product-page">
    <div id="productLoader" class="loading-center">Cargando producto‚Ä¶</div>

    <div class="product-grid" id="productGrid" style="display:none">
      <div class="product-media"><img id="productImage" src="https://via.placeholder.com/800x600?text=Producto"
          alt="Producto"></div>

      <div class="product-info">
        <h1 id="productTitle">Producto de ejemplo</h1>
        <div class="product-price" id="productPrice">$ 1.200</div>
        <div class="product-meta" id="productMeta">Marca: Demo ¬∑ Presentaci√≥n: 1 L</div>

        <div class="product-actions">
          <button class="btn btn-ghost btn-wide" onclick="window.location.href='productos.html'">Volver al
            listado</button>
          <button class="btn btn" id="reserveBtn">Reservar</button>
        </div>

        <div class="product-desc" id="productDesc">
          <h3>Descripci√≥n</h3>
          <p class="small muted">Descripci√≥n de ejemplo.</p>
          <h4 style="margin-top:12px">Ficha t√©cnica</h4>
          <ul class="small muted" id="productSpecs">
            <li>Rendimiento: ~10 m¬≤ / litro</li>
          </ul>
        </div>
      </div>
    </div>
  </main>

  <div id="adminModalBack" class="admin-modal-back" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="admin-modal">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <h2 style="margin:0">√Årea admin ‚Äî Reservas</h2>
          <div class="small muted">Solo para administradores.</div>
        </div>
        <div><button id="adminCloseTop" class="btn btn-ghost">Cerrar</button></div>
      </div>

      <div id="adminLoginBlock" style="margin-top:14px">
        <div style="display:flex;gap:10px;align-items:center">
          <input id="adminPinInput" placeholder="Ingres√° PIN"
            style="padding:10px;border-radius:8px;border:1px solid #eef6fb" />
          <button id="adminLoginBtn" class="btn btn-primary">Entrar</button>
          <div id="adminLoginMsg" class="small muted" style="margin-left:12px"></div>
        </div>
      </div>

      <div id="adminContent" style="display:none;margin-top:16px">
        <div class="admin-actions">
          <button id="adminSignout" class="btn">Cerrar sesi√≥n admin</button>
          <button id="refreshReservations" class="btn btn-primary">Actualizar</button>
        </div>
        <div style="margin-top:12px" class="admin-panel" id="adminPanel">
          <div class="small muted">Cargando reservas‚Ä¶</div>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer" role="contentinfo">
    <div class="site-footer__inner container">
      <div class="footer-col about"><a href="index.html" class="brand-link"><strong>Rep√∫blica Colores</strong></a>
        <p class="small muted">Soluciones en pinturas y terminaciones.</p>
      </div>
      <div class="footer-col links">
        <h4>Enlaces</h4>
        <ul>
          <li><a href="productos.html">Productos</a></li>
          <li><a href="promociones.html">Promociones</a></li>
          <li><a href="reservas.html">Reservas</a></li>
        </ul>
      </div>
      <div class="footer-col contact">
        <h4>Contacto</h4>
        <p class="small muted">San Jer√≥nimo 3321 ‚Ä¢ C√≥rdoba, AR</p>
        <p class="small muted">Tel: +54 351 618 5138</p>
      </div>
      <div class="footer-col social">
        <h4>S√≠guenos</h4>
        <div class="social-icons"><a href="#" aria-label="Facebook">üëç</a><a href="#" aria-label="Instagram">üì∏</a>
        </div>
      </div>
    </div>
    <div class="site-footer__bottom container">
      <div class="small muted">¬© <span id="footerYear"></span> Rep√∫blica Colores ‚Äî Todos los derechos reservados</div>
    </div>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDPVbxfvJO-w-j6lGL-TEFeHNJRV7G1UTo",
      authDomain: "inventario-b8fc2.firebaseapp.com",
      projectId: "inventario-b8fc2",
      storageBucket: "inventario-b8fc2.firebasestorage.app",
      messagingSenderId: "184222469977",
      appId: "1:184222469977:web:83cc7bcc7116eb43494648"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const COLLECTIONS = ['productos', 'products', 'items', 'inventario', 'productosListado'];

    const productGrid = document.getElementById('productGrid');
    const loader = document.getElementById('productLoader');
    const reserveBtn = document.getElementById('reserveBtn');

    const adminBtn = document.getElementById('adminBtn');
    const adminModalBack = document.getElementById('adminModalBack');
    const adminCloseTop = document.getElementById('adminCloseTop');
    const adminLoginBtn = document.getElementById('adminLoginBtn');
    const adminPinInput = document.getElementById('adminPinInput');
    const adminLoginMsg = document.getElementById('adminLoginMsg');
    const adminLoginBlock = document.getElementById('adminLoginBlock');
    const adminContent = document.getElementById('adminContent');
    const adminPanel = document.getElementById('adminPanel');
    const adminSignout = document.getElementById('adminSignout');
    const refreshReservations = document.getElementById('refreshReservations');

    const PIN_OFFSET = 11;
    const encodedPin = [60, 68, 65, 64];
    function decodePin() { return encodedPin.map(c => String.fromCharCode(c - PIN_OFFSET)).join(''); }
    function verifyPinInput(value) { return String(value || '').trim() === decodePin(); }

    function escapeHtml(s) { return String(s || '').replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;'); }

    async function findProductById(id) {
      for (const name of COLLECTIONS) {
        try {
          const docRef = doc(db, name, id);
          const snap = await getDoc(docRef);
          if (snap && snap.exists()) return { id: snap.id, ...snap.data(), _collection: name };
        } catch (e) { console.warn('err find in', name, e); }
      }
      for (const name of COLLECTIONS) {
        try {
          const colRef = collection(db, name);
          const snap = await getDocs(colRef);
          if (!snap.empty) {
            for (const d of snap.docs) {
              const data = d.data();
              if (data.slug === id || d.id === id || (data.code && data.code === id)) return { id: d.id, ...data, _collection: name };
            }
          }
        } catch (e) { console.warn('err search in', name, e); }
      }
      return null;
    }

    function populateProductUI(p) {
      if (!p) return;
      document.getElementById('productTitle').textContent = p.name || p.nombre || p.title || 'Sin nombre';
      document.getElementById('productPrice').textContent = (p.price || p.precio) == null ? 'Consultar' : ('$' + Number(p.price || p.precio).toLocaleString('es-AR'));
      document.getElementById('productMeta').textContent = (p.brand || p.marca ? 'Marca: ' + (p.brand || p.marca) : '') + (p.presentation ? ' ¬∑ ' + p.presentation : '');
      const imageSrc = p.imageUrl || p.image || (p.images && p.images[0]) || 'https://via.placeholder.com/800x600?text=Sin+imagen';
      const img = document.getElementById('productImage'); img.src = imageSrc; img.alt = document.getElementById('productTitle').textContent;
      document.querySelector('#productDesc p').textContent = p.description || p.desc || p.descripcion || 'Descripci√≥n no disponible.';
      const specs = document.getElementById('productSpecs'); specs.innerHTML = '';
      const specList = [];
      if (p.rendimiento) specList.push('Rendimiento: ' + p.rendimiento);
      if (p.drying) specList.push('Secado: ' + p.drying);
      if (p.application) specList.push('Aplicaci√≥n: ' + p.application);
      if (specList.length === 0) specs.innerHTML = '<li class="small muted">Ficha t√©cnica no disponible.</li>';
      else specList.forEach(s => { const li = document.createElement('li'); li.className = 'small muted'; li.textContent = s; specs.appendChild(li); });
    }

    async function loadReservations() {
      adminPanel.innerHTML = '<div class="small muted">Cargando reservas‚Ä¶</div>';
      try {
        const col = collection(db, 'reservas');
        const snap = await getDocs(col);
        if (snap.empty) { adminPanel.innerHTML = '<div class="small muted">No hay reservas registradas.</div>'; return; }
        let html = '<table><thead><tr><th>Nombre</th><th>DNI</th><th>Items</th><th>Total</th><th>Creado</th></tr></thead><tbody>';
        snap.forEach(d => {
          const data = d.data();
          const items = (data.items || []).map(it => `${it.name} x${it.qty}`).join('<br>');
          const total = data.total == null ? 'Consultar' : ('$' + Number(data.total).toLocaleString('es-AR'));
          let created = '';
          if (data.createdAt && data.createdAt.toDate) {
            try { created = data.createdAt.toDate().toLocaleString(); } catch (e) { created = String(data.createdAt); }
          } else created = '-';
          html += `<tr><td>${escapeHtml(data.name || '-')}</td><td>${escapeHtml(data.dni || '-')}</td><td style="min-width:220px">${items || '-'}</td><td>${total}</td><td>${created}</td></tr>`;
        });
        html += '</tbody></table>';
        adminPanel.innerHTML = html;
      } catch (err) {
        console.error('err cargando reservas', err);
        adminPanel.innerHTML = '<div class="small muted">Error cargando reservas (ver consola).</div>';
      }
    }

    function openAdminModal() { adminModalBack.style.display = 'flex'; adminModalBack.setAttribute('aria-hidden', 'false'); const authed = sessionStorage.getItem('rc_admin_authed'); if (authed === '1') { adminLoginBlock.style.display = 'none'; adminContent.style.display = ''; loadReservations(); } else { adminLoginBlock.style.display = ''; adminContent.style.display = 'none'; adminPinInput.value = ''; adminLoginMsg.textContent = ''; adminPinInput.focus(); } }
    function closeAdminModal() { adminModalBack.style.display = 'none'; adminModalBack.setAttribute('aria-hidden', 'true'); }

    adminBtn.addEventListener('click', () => openAdminModal());
    adminCloseTop.addEventListener('click', () => closeAdminModal());
    adminModalBack.addEventListener('click', (e) => { if (e.target === adminModalBack) closeAdminModal(); });
    adminLoginBtn && adminLoginBtn.addEventListener('click', () => {
      const val = adminPinInput.value || '';
      if (verifyPinInput(val)) { sessionStorage.setItem('rc_admin_authed', '1'); adminLoginMsg.textContent = ''; adminLoginBlock.style.display = 'none'; adminContent.style.display = ''; loadReservations(); } else { adminLoginMsg.style.color = '#b91c1c'; adminLoginMsg.textContent = 'PIN incorrecto.'; }
    });
    adminSignout && adminSignout.addEventListener('click', () => { sessionStorage.removeItem('rc_admin_authed'); adminContent.style.display = 'none'; adminLoginBlock.style.display = ''; adminLoginMsg.textContent = 'Sesi√≥n cerrada.'; });
    refreshReservations && refreshReservations.addEventListener('click', () => loadReservations());

    function goToReserveWithId(id) { if (!id) return; location.href = 'reservas.html?id=' + encodeURIComponent(id); }

    (function () {
      document.addEventListener('DOMContentLoaded', async function () {
        document.getElementById('footerYear').textContent = new Date().getFullYear();
        const params = new URLSearchParams(location.search);
        const id = params.get('id') || params.get('product') || params.get('sku');
        if (!id) { loader.textContent = 'No se indic√≥ producto (par√°metro ?id=).'; return; }
        loader.textContent = 'Buscando producto‚Ä¶';
        const product = await findProductById(id);
        if (product) {
          populateProductUI(product);
          const reserveBtnEl = document.getElementById('reserveBtn');
          if (reserveBtnEl) reserveBtnEl.addEventListener('click', () => goToReserveWithId(product.id || id));
          loader.style.display = 'none';
          productGrid.style.display = '';
        } else {
          loader.innerHTML = '<div>No se encontr√≥ el producto. Mostrando ejemplo.</div>';
          const demo = { name: 'Pintura Acr√≠lica Interior (demo)', price: 1200, brand: 'Marca Demo', imageUrl: 'https://via.placeholder.com/800x600?text=Producto+Demo', description: 'Demostraci√≥n: no se encontr√≥ en la base de datos.', id: id };
          populateProductUI(demo);
          const reserveBtnEl = document.getElementById('reserveBtn');
          if (reserveBtnEl) reserveBtnEl.addEventListener('click', () => goToReserveWithId(demo.id));
          loader.style.display = 'none';
          productGrid.style.display = '';
        }
      });
    })();

    function doSearchIndex() { var q = document.getElementById('globalSearch') ? document.getElementById('globalSearch').value.trim() : ''; if (!q) return location.href = 'productos.html'; location.href = 'productos.html?q=' + encodeURIComponent(q); }
    adminPinInput && adminPinInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        adminLoginBtn && adminLoginBtn.click();
      }
      if (e.key === 'Escape') {
        if (adminModalBack.style.display === 'flex') closeAdminModal();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (adminModalBack.style.display === 'flex') closeAdminModal();
      }
    });

    window.rcAdmin = {
      openAdminModal,
      closeAdminModal,
      loadReservations,
      decodePin,
      verifyPinInput
    };

    const reserveBtnEl = document.getElementById('reserveBtn');
    if (reserveBtnEl) {
      reserveBtnEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          reserveBtnEl.click();
        }
      });
    }
  </script>
</body>

</html>
